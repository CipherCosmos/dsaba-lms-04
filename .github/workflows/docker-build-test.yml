name: Docker Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  build-and-test:
    name: Build Docker Images and Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          tags: dsaba-lms-backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          tags: dsaba-lms-frontend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Start services with Docker Compose
        run: |
          docker compose up -d
          sleep 20

      - name: Check service health
        run: |
          docker compose ps
          docker compose exec -T backend curl -f http://localhost:8000/health || exit 1
          docker compose exec -T frontend wget --spider --quiet http://localhost/ || exit 1

      - name: Run database migrations
        run: |
          docker compose exec -T backend alembic upgrade head

      - name: Run backend tests
        run: |
          docker compose exec -T backend pytest tests/ --cov=src --cov-report=term-missing -v --tb=short

      - name: View logs on failure
        if: failure()
        run: |
          echo "=== Backend Logs ==="
          docker compose logs backend
          echo "=== Frontend Logs ==="
          docker compose logs frontend
          echo "=== Postgres Logs ==="
          docker compose logs postgres
          echo "=== Redis Logs ==="
          docker compose logs redis

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v

